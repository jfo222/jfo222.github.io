import e from"./config.json"with{type:"json"};(()=>{let t,n,o,s,r,a,[c,i,l,u]=[0,0,0,0],p="char";let d=new AudioContext,m={down:0,range:e.autoUp+1,up:0},[f,h]=[document.body,document.head],g=["char","color"],y=window.speechSynthesis,v=async()=>{a=await navigator.wakeLock.request("screen")};function w(e,t=f){return t.querySelector(e)}function N(e,t){let n=document.createElement(e);return t&&t.append(n),n}function q(e,t=1){let n=N("div",f);if(n.className="error",n.textContent=`[${e}]`,t)throw new Error(e)}function x(t){if(!e.sound)return;let n=Object.assign({gain:.2,ramp:1,start:0,wave:"sine"},t),o=new OscillatorNode(d,{frequency:n.freq,type:n.wave}),s=new GainNode(d,{gain:n.gain});s.gain.setValueAtTime(n.gain,d.currentTime+n.start+.01),n.ramp&&s.gain.exponentialRampToValueAtTime(1e-4,d.currentTime+n.stop),o.connect(s).connect(d.destination),o.start(d.currentTime+n.start),o.stop(d.currentTime+n.stop)}function C(){let[e,t]=[0,13];for(;t<68;)x({freq:1600,start:e/100,stop:t/100}),e+=9,t+=9}function E(e,t=1){if(!y)return;let n=new SpeechSynthesisUtterance(e);n.lang=navigator.language,n.rate=1.1,n.volume=t,y.speak(n)}function L(e,t,n){let o;n&&(e.textContent=n),e.addEventListener("pointerdown",()=>{x({freq:540,stop:.1}),e.classList.add("active"),o=1,document.addEventListener("pointerup",()=>{e.classList.remove("active"),o=0},{once:1})}),e.addEventListener("pointerup",()=>{o&&(e.classList.remove("active"),o=0,t(e))})}function $(t=e.limitMin){[l,m.up,m.down]=[t,0,0]}function P(){[...f.childNodes].forEach(e=>e.remove())}function A(){let t=w("#tmpl-1",h).content.cloneNode(1);function s(){$(),w(".result")?.remove()}function r(t){return t&&(e.autoUp>=m.range?e.autoUp=1:e.autoUp+=1,s()),m.up>0?`${m.up} / ${e.autoUp}`:`${o.ctrl[0]} ${e.autoUp}`}function a(t){return t&&(e.sound=!e.sound),e.sound?"ðŸ”Š":"ðŸ”‡"}function c(t){return t&&(p=g.find(e=>p!==e),s(),w(".x").textContent=r()),"color"===p?o.ctrl[1]:e.alphanumeric?"A-9":"0-9"}P(),L(w(".x",t),e=>{e.textContent=r(1)},r()),L(w(".speaker",t),e=>{e.textContent=a(1)},a()),L(w(".alt",t),e=>{e.textContent=c(1)},c()),L(w(".help",t),e=>{e.firstChild.nodeValue?(e.firstChild.replaceWith(N("ol")),Object.values(o.ol).forEach(t=>{N("li",e.firstChild).textContent=t})):e.textContent="?"},"?"),L(w(".circle",t),k),L(w(".screen",t),()=>{document.fullscreenElement?document.exitFullscreen():f.parentNode.requestFullscreen()}),document.fullscreenEnabled||(w(".screen",t).className="none"),[n,l,M.true]=[[],l>99?e.limitMin:l,0],f.append(t)}function T(){let t="";let[n,o,a]=[[],[],e.qty[p]],c=e=>e.splice(Math.floor(Math.random()*e.length),1)[0];function i(e,t){let[n,o]=[e.codePointAt(1),t.codePointAt(1)];return n+1===o||n-1===o}for({char(){let t=[...new Array(10).keys()].map(e=>48+e);if(e.alphanumeric)for(t.push(...[...new Array(26).keys()].map(e=>65+e));t.length>a;)c(t);else t.push(t.shift());r=t.map(e=>JSON.stringify(String.fromCodePoint(e))),s=1},color(){r=["#157717","#d82727","#3131d3","#d6c918","#8a008a","#d56e2a","#7d6040","#56a","#63cfc4","#42be42","#fff","#bb63ad"],s=0}}[p](),a<r.length&&(r.length=a),o.push(...r),t=c(o);n.push(t)<l;)for(;t===n.at(-1)||"char"===p&&i(t,n.at(-1));)t=c(o),o.length||o.push(...r);return n}function S(){let o,[s,a]=[0,0];let c=w(".panel"),[i,u]=[[...t.reverse()],[...r]],d="color"===p?()=>u.splice(Math.floor(Math.random()*u.length),1)[0]:()=>u.shift(),m=e.qty[p]%e.columns,f=m?e.qty[p]+e.columns-m:e.qty[p];function h(e){if(M.true)return;let t=e.style.getPropertyValue("--stm"),o=t!==i.shift();(n.push(t)===l||o)&&M(o)}for(c.style.setProperty("--clms",e.columns);s<f;)o=N("li",c),a<r.length&&(!m||3!==e.columns||s!==f-3)&&(o.style.setProperty("--stm",d()),o.className=p,L(o,h),a+=1),s+=1}function U(){clearTimeout(i),clearInterval(u),y?.cancel(),a?.release()}function b(n){function o(){if(c===l)return U(),n.remove(),void S();let o=t[c];c+=1,document.hidden||(requestAnimationFrame(()=>{n.classList.add(p),n.style.setProperty("--stm",o),e.sound&&s?E(o.replace(/"/g,"")):E(" ",0)}),n.addEventListener("animationend",()=>{n.classList.remove(p)},{once:1}))}i=setTimeout(()=>{o(),u=setInterval(o,e.timeRate)},1500)}function k(){let n=w("#tmpl-2",h).content.cloneNode(1),o=w(".sq",n);P(),c=0,L(w(".esc",n),()=>{U(),$(),A()}),f.append(n),e.qty[p]<6&&q("Unsound value"),t=T(),E(" ",0),v(),b(o)}function M(s){let r=w("#tmpl-3",h).content.cloneNode(1),a=[...w(".result",r).children],[c,i]=[t.length,n.length];function u(e){t.length=e,t.push(JSON.stringify("..."))}function d(e){[t,n].forEach(t=>{t.splice(0,e),t.unshift(JSON.stringify("..."))})}M.true=1,setTimeout(()=>{s?(m.down+=1,t.length>10&&(i<7?u(10):i<c-5?(u(i+4),d(i-6)):d(c-10)),a[0].textContent=`- ${o.res[0]} -`,a[1].classList.add("match"),a[1].style.setProperty("--match",t.length),[...t,...n].forEach(e=>{let t=N("span",a[1]);t.style.setProperty("--stm",e),t.className=e.includes(".")?"char":p}),a[2].className="none",m.down===e.autoDown&&l!==e.limitMin&&(l-=1,$(l)),x({freq:140,gain:.18,ramp:0,stop:.6,wave:"sawtooth"}),m.up=0):(m.up+=1,[`- ${o.res[1]} -`,`${o.res[2]}: ${l}`,`${o.res[3]}: ${l<5?o.res[4]:l<8?o.res[5]:o.res[6]}`].forEach((e,t)=>{a[t].textContent=e}),m.up===e.autoUp&&(a[1].className="complete",l+=1,$(l)),C(),m.down=0),A(),f.append(r)},150)}document.addEventListener("touchstart",e=>{e.preventDefault()},{passive:0}),(async e=>{let t=await fetch(e);t.ok||q("No language file"),o=await t.json()})(`./lang/${e.lang}.json`).then(()=>(f.style.setProperty("--time",e.timeStimulus/1e3+"s"),$(),A(),void(y||q("No speech API",0))))})();

